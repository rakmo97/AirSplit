<!DOCTYPE html>
<html>
<head lang="en">
   <meta charset="utf-8">
   <title>Activity Log</title>
   <script src="Stay.js"></script>
   <script>

      // Wait until the window finishes loaded before executing any script
      window.onload = function() {

        var totalCost, totalNights;
        let orgPersons = [];
        let orgNights = [];
        var orgCosts = [];

        var recal = 1;
        var recalculating = false;
        
        // Initialize the activityNumber
        var activityNumber = 1;

        // Select the add_activity button
        var addButton = document.getElementById("add_activity");

        // Select the calculate button
        var calcButton = document.getElementById("calculate");

        // Select the table element
        var divTable = document.getElementById("divlist");

        // Select the table element
        var resultTable = document.getElementById("resultlist");

        const stay = new Stay(document.getElementById("totalCost").value, document.getElementById("totalNights").value);

        // Attach handler to the button click event
        addButton.onclick = function() {

        // Add a new row to the table using the correct activityNumber

          if (recalculating){
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>Person</label><br/> \
            <input type="text" name="reperson' + recal + '" id="AddReperson' + recal + '"  value="" placeholder="Name"> \
            <input type="text" name="renights' + recal + '" id="AddRenights' + recal + '" value="" placeholder="Nights"></td></tr>');
            recal++;
          }
          else{
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>Person ' + activityNumber + ': </label><br/> \
              <input type="text" name="person' + activityNumber + '" id="person' + activityNumber + '" class="required" placeholder="Name"> \
              <input type="text" id="nightS' + activityNumber + '" name="nights' + activityNumber + '" value="" placeholder="Nights"></td></tr>');
          }
          // Increment the activityNumber
          activityNumber += 1;
        }

        document.getElementById("calculate").addEventListener("click", function() {


          totalCost = document.getElementById("totalCost").value;
          totalNights = document.getElementById("totalNights").value;

          const stay = new Stay(totalCost, totalNights);

          var inputs, index;
          
          //Create NodeList
          inputs = document.getElementsByTagName('input');

          //convert nodelist into array
          var inputsArr = Array.from(inputs);

          for (index = 0; index < inputs.length-3; ++index) {
            var per, night;

            per = inputsArr[index].value;
            orgPersons.push(per);
            index++;
            night = inputsArr[index].value;
            orgNights.push(night);

            stay.AddPerson(per,  Array.from(String(night), Number));

          }

          orgCosts = stay.CalculateOriginalCosts();

          divTable.insertAdjacentHTML("beforeend", '<tr><td><label>LATEST CALCULATION</label><br/></td></tr>');
          for (index = 0; index < orgCosts.length; ++index) {
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>' + orgPersons[index] + ': $</label><label>' + orgCosts[index].toFixed(2) + '</label><br/></td></tr>');
          }

          document.getElementById("calculate").disabled = true;
          document.getElementById("recalculate").disabled = false;
          document.getElementById("add_activity").disabled = true;


        }, false);


        document.getElementById("recalculate").addEventListener("click", function() {

          recalculating = true;
          recal = 1;
          var index;

          for (index = 0; index < orgPersons.length; ++index) {
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>' + orgPersons[index] + ' </label><br/> \
            <input type="text" name="reperson' + recal + '" id="reperson' + recal + '"  value="' + orgPersons[index] + '"> \
            <input type="text" name="renights' + recal + '" id="renights' + recal + '" value="' + orgNights[index] + '" ></td></tr>');
            recal++;
          }

          document.getElementById("recalculate").disabled = true;
          document.getElementById("redistribute").disabled = false;
          document.getElementById("add_activity").disabled = false;


        }, false);

        document.getElementById("redistribute").addEventListener("click", function() {

          var index;
          let repersons = [];
          let renights = [];

          const stay = new Stay(totalCost, totalNights);

          for (index = 0; index < orgPersons.length; index++) {
            stay.AddPerson(orgPersons[index],  Array.from(String(orgNights[index]), Number));
          }

          stay.CalculateOriginalCosts();
          
          repersons = document.querySelectorAll('[id^="reperson"]');
          var repersonsArr = Array.from(repersons);
          renights = document.querySelectorAll('[id^="renights"]');
          var renightsArr = Array.from(renights);

          AddRepersons = document.querySelectorAll('[id^="AddReperson"]');
          var AddRepersonsArr = Array.from(AddRepersons);
          AddRenights = document.querySelectorAll('[id^="AddRenights"]');
          var AddRenightsArr = Array.from(AddRenights);

          for (index=0; index < repersonsArr.length; index++){

            if (renightsArr[index].value != orgNights[index]){
              stay.ChangePersonNights(repersonsArr[index].value, Array.from(String(renightsArr[index].value), Number))
            }

          }

          for (index = 0; index < AddRepersons.length; index++) {
            stay.AddPerson(AddRepersonsArr[index].value, Array.from(String(AddRenightsArr[index].value), Number))
          }

          stay.CalculateRedistribution();

          //print(" - Guest {} is staying {} nights and owes ${:.2f}.".format(self.name_list[j],len(self.nights_staying_list[j]),self.person_shareprice_list_new[j]))

          for (index = 0; index < stay.num_guests; index++) {
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>' + stay.name_list[index] + ' is staying ' + stay.nights_staying_list[index].length + ' nights and owes: $</label><label>' + stay.person_shareprice_list_new[index].toFixed(2) + '</label><br/></td></tr>');
          }

          divTable.insertAdjacentHTML("beforeend", '<tr><td><br/></td></tr>');

          //print(" - Guest {} should {} ${:.2f}.".format(self.name_list[j], "send" if self.amount_to_send[j]>0 else "receive", self.amount_to_send[j]))

          for (index = 0; index < stay.num_guests; index++) {
            divTable.insertAdjacentHTML("beforeend", '<tr><td><label>' + stay.name_list[index] + ' should ' + ((stay.amount_to_send[index] > 0) ? 'send' : 'receive') + ': $</label><label>' + Math.abs(stay.amount_to_send[index]).toFixed(2) + '</label><br/></td></tr>');
          }

          document.getElementById("add_activity").disabled = true;
          document.getElementById("redistribute").disabled = true;


        }, false);

      }

   </script>

</head>

<body>
  <div class="container">
      <div class="row">
          <div class="leftcol">
              <form name='mainForm' id='mainForm' method="get" action="#">
                <fieldset>
                   <legend>Input Information</legend>
                   <table id="divlist">
                    <!--tr>
                      <th colspan="3">Track List: </th>
                    </tr>
                    <tr>
                      <td>1</td>
                      <td> <label>Person 1: </label> <br/> <input type="text" id="person1" name="person1" value="" class="required"><input type="text" name="nights1" class="required"> </td>
                    </tr>
                    <tr>
                      <td>2</td>
                      <td><label>Person 2: </label><br/><input type="text" name="person2" id="person2" class="required"><input type="text" name="nights2" class="required"></td>
                    </tr-->
                   </table>
                </fieldset>
              </form>
              <button id="add_activity">Add Person</button>
              <button id="calculate">Calculate</button>
              <button id="recalculate" disabled>Make Changes</button>
              <button id="redistribute" disabled>Redistribute</button>
              <label>Total Cost: </label>
              <input type="number" name="totalCost" id="totalCost" class="required">
              <label>Total Number of Nights: </label>
              <input type="number" name="person2" id="totalNights"class="required">
              <br/><br/><br/><br/>
              <button onClick="window.location.reload();">Start Over</button>
          </div>
      </div>
  </div>
</body>
</html>

